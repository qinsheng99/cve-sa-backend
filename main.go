package main

import (
	"log"

	"github.com/robfig/cron/v3"

	"cve-sa-backend/handles"
	"cve-sa-backend/iniconf"
	manageRouters "cve-sa-backend/routers/manage"
	webRouters "cve-sa-backend/routers/web"

	"github.com/gin-gonic/gin"
)

func main() {
	// init config
	inErr := iniconf.InitConf()
	if inErr != nil {
		log.Println("inErr: ", inErr)

		return
	}
	// init logs
	logErr := iniconf.InitLogger()
	if logErr != nil {
		log.Println("logErr: ", logErr)

		return
	}
	// init mysql
	gormErr := iniconf.InitGormMysql()
	if gormErr != nil {
		log.Println("gormErr: ", gormErr)

		return
	}
	r := gin.Default()

	webRouters.WebRouters(r)
	manageRouters.ManageRouters(r)

	Conf, err := iniconf.Cfg.GetSection("basic")
	if err != nil {
		log.Println("Fail to load section 'server': ", err)

		return
	}

	c := cron.New(cron.WithSeconds())
	err = handles.Task(c)
	if err != nil {
		log.Println("failed task, err:", err.Error())

		return
	}
	c.Start()
	defer c.Stop()

	port := Conf.Key("PORT").MustString("8080")
	runErr := r.Run(":" + port)
	if runErr != nil {
		iniconf.SLog.Error("server run failed,", runErr)
		log.Println("runErr: ", runErr)

		return
	}
}
